{% extends "base.html" %}

{% block title %}AI Recommender - Columnar Transposition Cipher{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ AI Key Recommender</h1>
    <p>Get intelligent key recommendations based on statistical analysis</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Analysis Configuration</h2>
    </div>
    <div class="card-body">
        <form id="recommender-form">
            <div class="form-group">
                <label for="ciphertext">Ciphertext to Analyze:</label>
                <textarea id="ciphertext" name="ciphertext" rows="5" 
                          placeholder="Enter the encrypted message..." required></textarea>
                <small>The ciphertext for which you need key recommendations</small>
            </div>

            <div class="form-group">
                <label for="num_recommendations">Number of Recommendations:</label>
                <input type="number" id="num_recommendations" name="num_recommendations" 
                       value="10" min="1" max="20">
                <small>How many key recommendations to generate</small>
            </div>

            <div class="form-group">
                <label for="max_key_length">Maximum Key Length:</label>
                <input type="number" id="max_key_length" name="max_key_length" 
                       value="10" min="2" max="15">
                <small>Maximum key length to consider</small>
            </div>

            <button type="submit" class="btn btn-success btn-large">
                ü§ñ Get Recommendations
            </button>
        </form>
    </div>
</div>

<div id="key-length-section" class="card" style="display: none;">
    <div class="card-header">
        <h2>üìè Suggested Key Lengths</h2>
    </div>
    <div class="card-body">
        <div id="key-length-suggestions"></div>
    </div>
</div>

<div id="recommendations-section" class="card" style="display: none;">
    <div class="card-header">
        <h2>üéØ Key Recommendations</h2>
        <span id="recommendations-count" class="badge"></span>
    </div>
    <div class="card-body">
        <div id="recommendations-container"></div>
    </div>
</div>

<div class="card info-card">
    <div class="card-header">
        <h3>üí° How AI Recommender Works</h3>
    </div>
    <div class="card-body">
        <h4>Analysis Methods:</h4>
        <ul>
            <li><strong>Index of Coincidence:</strong> Analyzes character distribution to suggest key lengths</li>
            <li><strong>Factor Analysis:</strong> Examines ciphertext length factors as potential key lengths</li>
            <li><strong>Pattern Recognition:</strong> Identifies column arrangement patterns</li>
            <li><strong>Frequency Analysis:</strong> Compares character frequencies to English text</li>
            <li><strong>N-gram Scoring:</strong> Evaluates bigrams, trigrams, and quadgrams</li>
            <li><strong>Dictionary Matching:</strong> Detects valid English words in decrypted text</li>
        </ul>
        
        <h4>Confidence Scores:</h4>
        <ul>
            <li><strong>80-100%:</strong> Very high confidence - likely correct</li>
            <li><strong>60-79%:</strong> High confidence - strong candidate</li>
            <li><strong>40-59%:</strong> Medium confidence - worth trying</li>
            <li><strong>Below 40%:</strong> Low confidence - less likely but possible</li>
        </ul>
        
        <h4>Tips for Best Results:</h4>
        <ul>
            <li>Longer ciphertexts provide better analysis (50+ characters recommended)</li>
            <li>Check multiple recommendations - the top one may not always be correct</li>
            <li>Use recommended key lengths as hints for manual attempts</li>
            <li>Combine with the Attack feature for comprehensive cracking</li>
        </ul>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('recommender-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const ciphertext = document.getElementById('ciphertext').value;
    const numRecommendations = document.getElementById('num_recommendations').value;
    const maxKeyLength = document.getElementById('max_key_length').value;
    
    showLoading();
    
    try {
        const response = await fetch('/api/recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ciphertext: ciphertext,
                num_recommendations: numRecommendations,
                max_key_length: maxKeyLength
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Display key length suggestions
            displayKeyLengthSuggestions(data.key_length_suggestions);
            document.getElementById('key-length-section').style.display = 'block';
            
            // Display recommendations
            displayRecommendations(data.recommendations);
            document.getElementById('recommendations-section').style.display = 'block';
            document.getElementById('recommendations-count').textContent = 
                `${data.recommendations.length} recommendations`;
            
            showToast('Analysis complete!', 'success');
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
});

function displayKeyLengthSuggestions(suggestions) {
    const container = document.getElementById('key-length-suggestions');
    
    let html = '<div class="suggestions-grid">';
    
    suggestions.slice(0, 5).forEach((suggestion, index) => {
        const confidenceClass = getConfidenceClass(suggestion.confidence);
        
        html += `
            <div class="suggestion-item">
                <div class="suggestion-rank">#${index + 1}</div>
                <div class="suggestion-length">Length: ${suggestion.length}</div>
                <div class="suggestion-confidence ${confidenceClass}">
                    ${suggestion.confidence.toFixed(1)}%
                </div>
                <div class="suggestion-reason">${suggestion.reason}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    
    if (recommendations.length === 0) {
        container.innerHTML = '<p class="no-results">No recommendations generated. Try adjusting parameters.</p>';
        return;
    }
    
    let html = '<div class="recommendations-list">';
    
    recommendations.forEach((rec, index) => {
        const rank = index + 1;
        const confidenceClass = getConfidenceClass(rec.confidence);
        
        html += `
            <div class="recommendation-item">
                <div class="recommendation-header">
                    <span class="recommendation-rank">#${rank}</span>
                    <span class="recommendation-key">Key: ${rec.key}</span>
                    <span class="recommendation-length">(Length: ${rec.key_length})</span>
                    <span class="recommendation-confidence ${confidenceClass}">
                        ${rec.confidence.toFixed(1)}% confidence
                    </span>
                </div>
                <div class="recommendation-score">
                    Score: ${rec.score.toFixed(2)}
                </div>
                <div class="recommendation-reason">
                    <em>${rec.reason}</em>
                </div>
                <div class="recommendation-plaintext">
                    <strong>Decrypted text preview:</strong>
                    <pre>${rec.plaintext.substring(0, 200)}${rec.plaintext.length > 200 ? '...' : ''}</pre>
                </div>
                <div class="recommendation-actions">
                    <button class="btn btn-small btn-secondary" 
                            onclick="copyText('${rec.key}')">
                        üìã Copy Key
                    </button>
                    <button class="btn btn-small btn-secondary" 
                            onclick="copyText('${rec.plaintext.replace(/'/g, "\\'")}')">
                        üìã Copy Plaintext
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function getConfidenceClass(confidence) {
    if (confidence >= 80) return 'confidence-high';
    if (confidence >= 60) return 'confidence-medium-high';
    if (confidence >= 40) return 'confidence-medium';
    return 'confidence-low';
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    });
}
</script>
{% endblock %}
